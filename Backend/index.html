<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Support Chat</title>
<style>
  body {
    margin: 0;
    background: #0f172a;
    font-family: system-ui, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .chat {
    width: 420px;
    height: 600px;
    background: #020617;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }

  .header {
    padding: 14px;
    text-align: center;
    color: #e5e7eb;
    border-bottom: 1px solid #1e293b;
    font-weight: 600;
  }

  .messages {
    flex: 1;
    padding: 14px;
    overflow-y: auto;
    color: #e5e7eb;
  }

  .msg {
    max-width: 75%;
    margin-bottom: 10px;
    padding: 10px 12px;
    border-radius: 10px;
    line-height: 1.4;
    font-size: 14px;
  }

  .user {
    background: #2563eb;
    color: white;
    margin-left: auto;
  }

  .ai {
    background: #1e293b;
  }

  .input {
    display: flex;
    border-top: 1px solid #1e293b;
  }

  input {
    flex: 1;
    background: transparent;
    border: none;
    padding: 14px;
    color: #e5e7eb;
    outline: none;
  }

  button {
    background: #2563eb;
    border: none;
    padding: 0 20px;
    color: white;
    cursor: pointer;
  }

  button:disabled,
  input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .loading {
    text-align: center;
    opacity: 0.7;
    margin-top: 20px;
  }
</style>
</head>
<body>

<div class="chat">
  <div class="header">Support Chat</div>
  <div class="messages" id="messages"></div>
  <div class="input">
    <input id="input" placeholder="Type a message..." disabled />
    <button id="sendBtn" onclick="send()" disabled>Send</button>
  </div>
</div>

<script>
const API_BASE = "http://localhost:3000";
const messagesEl = document.getElementById("messages");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

let sessionId = localStorage.getItem("sessionId");

function setLoading(state, text = "Loading...") {
  inputEl.disabled = state;
  sendBtn.disabled = state;

  if (state) {
    messagesEl.innerHTML = `<div class="loading">${text}</div>`;
  }
}

function renderMessages(messages) {
  messagesEl.innerHTML = "";
  messages.forEach(m => {
    const div = document.createElement("div");
    div.className = `msg ${m.sender}`;
    div.textContent = m.text;
    messagesEl.appendChild(div);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function loadHistory() {
  if (!sessionId) {
    inputEl.disabled = false;
    sendBtn.disabled = false;
    return;
  }

  setLoading(true, "Loading conversation...");
  try {
    const res = await fetch(`${API_BASE}/chat/${sessionId}`);
    const data = await res.json();
    renderMessages(data.messages || []);
  } catch {
    messagesEl.innerHTML = `<div class="loading">Failed to load chat</div>`;
  } finally {
    inputEl.disabled = false;
    sendBtn.disabled = false;
  }
}

async function send() {
  const text = inputEl.value.trim();
  if (!text) return;

  inputEl.value = "";
  inputEl.disabled = true;
  sendBtn.disabled = true;

  const temp = document.createElement("div");
  temp.className = "msg user";
  temp.textContent = text;
  messagesEl.appendChild(temp);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try {
    const res = await fetch(`${API_BASE}/chat/message`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, sessionId })
    });

    const data = await res.json();
    sessionId = data.sessionId;
    localStorage.setItem("sessionId", sessionId);

    const ai = document.createElement("div");
    ai.className = "msg ai";
    ai.textContent = data.reply;
    messagesEl.appendChild(ai);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  } finally {
    inputEl.disabled = false;
    sendBtn.disabled = false;
  }
}

inputEl.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});

loadHistory();
</script>

</body>
</html>
